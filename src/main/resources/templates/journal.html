<!DOCTYPE html>
<html lang="uk" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title th:text="${journal.name}">Журнал</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" th:href="@{/css/journal.css}" />
</head>
<body>
<header class="site-header">
    <div class="container">
        <div class="header-left">
            <a class="exit-btn" th:href="@{/admin/dashboard#journals}"
               title="Повернутися до Адмін-панелі"
            >Назад</a>
            <span class="brand">
                <span class="brand__logo"></span>
                <span class="brand__title" th:text="${journal.name}">Назва Журналу</span>
            </span>
        </div>

        <nav class="header-tabs" id="journalTabs">
            <button class="tab-btn active" data-tab="info">Основні відомості</button>
            <button class="tab-btn" data-tab="students">Облік дітей</button>
            <button class="tab-btn" data-tab="kp1">КП-1</button>
            <button class="tab-btn" data-tab="kp2">КП-2</button>
            <button class="tab-btn" data-tab="safety">Інструктаж</button>
            <button class="tab-btn" data-tab="org">Орг. робота</button>
            <button class="tab-btn" data-tab="method">Метод. робота</button>
            <button class="tab-btn" data-tab="creative">Творчі досягнення</button>
            <button class="tab-btn" data-tab="report">Статзвіт</button>
            <button class="tab-btn" data-tab="vacation">Відпустки/Відрядження</button>
            <button class="tab-btn" data-tab="remarks">Зауваження</button>
        </nav>
    </div>
</header>

<main class="page">
    <div class="card">

        <div class="alert-messages">
            <div th:if="${journalError}" class="alert alert--error">
                <strong>Помилка:</strong> <span th:text="${journalError}"></span>
            </div>
            <div th:if="${journalSuccess}" class="alert alert--success">
                <strong>Успіх:</strong> <span th:text="${journalSuccess}"></span>
            </div>
        </div>

        <section id="panel-info" class="tab-panel active">
            <h3 class="section-title">Основні відомості</h3>

            <div class="actions-bar">
                <form th:action="@{/admin/journals/{id}/generate-ktp(id=${journal.id})}" method="post"
                      onsubmit="return confirm('Це видалить існуючий КТП (крім проведених занять) і згенерує новий на основі дат та розкладу. Ви впевнені?');">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                    <button type="submit" class="btn btn--danger">Згенерувати/Оновити КТП</button>
                </form>
                <p class="helper" style="margin: 0;">(Натисніть для автоматичної генерації планових дат на основі розкладу та календаря)</p>
            </div>

            <form th:action="@{/journal/{id}/update-details(id=${journal.id})}" method="post" class="main-details-form">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

                <div class="journal-info">
                    <div class="info-block"><strong>Журнал (Гурток):</strong><span th:text="${journal.subject.name}"></span></div>
                    <div class="info-block"><strong>Навчальний рік:</strong><span th:text="${journal.academicYear.name}"></span></div>
                    <div class="info-block"><strong>Відділ:</strong><span th:text="${journal.subject.department.name}"></span></div>
                    <div class="info-block"><strong>Викладачі:</strong>
                        <th:block th:if="${!#lists.isEmpty(journal.teachers)}">
                             <span th:each="teacher, iter : ${journal.teachers}">
                                 <span th:text="${teacher.name + ' ' + teacher.surname}"></span>
                                 <span th:if="!${iter.last}">, </span>
                             </span>
                        </th:block>
                        <span th:if="${#lists.isEmpty(journal.teachers)}" class="helper">Не призначено</span>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
                    <div class="form-group">
                        <label for="programName">Назва програми</label>
                        <input id="programName" name="programName" type="text" th:value="${journal.programName}" placeholder="Навчальна програма" />
                    </div>
                    <div class="form-group">
                        <label for="studyLevel">Рівень навчання</label>
                        <select id="studyLevel" name="studyLevel">
                            <option th:value="${null}" th:text="'— Не обрано —'" th:selected="${journal.studyLevel == null}"></option>
                            <option th:value="'початковий'" th:text="'Початковий'" th:selected="${journal.studyLevel == 'початковий'}"></option>
                            <option th:value="'основний'" th:text="'Основний'" th:selected="${journal.studyLevel == 'основний'}"></option>
                            <option th:value="'вищий'" th:text="'Вищий'" th:selected="${journal.studyLevel == 'вищий'}"></option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="studyYear">Рік навчання</label>
                        <input id="studyYear" name="studyYear" type="text" th:value="${journal.studyYear}" placeholder="Перший, другий..." />
                    </div>
                    <div class="form-group">
                        <label for="groupNumber">Номер групи</label>
                        <input id="groupNumber" name="groupNumber" type="text" th:value="${journal.groupNumber}" placeholder="1, 2, 3..." />
                    </div>

                    <div class="form-group">
                        <label for="hoursPerWeek">Кількість годин на тиждень</label>
                        <input id="hoursPerWeek" name="hoursPerWeek" type="number" th:value="${journal.hoursPerWeek}" required placeholder="Напр., 4" />
                    </div>
                    <div class="form-group">
                        <label for="scheduleJson">Розклад занять (ЧТ: 16:00-17:45, ПТ: 16:00-17:45)</label>
                        <input id="scheduleJson" name="scheduleJson" type="text" th:value="${journal.scheduleJson}" required placeholder="ПН: 10:00-11:45, СР: 10:00-11:45" />
                        <p class="helper">Вкажіть **кожен** день та час через кому (ПН, ВТ, СР, ЧТ, ПТ, СБ, НД).</p>
                    </div>

                    <div class="form-group">
                        <label for="startDate">Дата початку занять</label>
                        <input id="startDate" name="startDate" type="date" th:value="${journal.startDate}" required />
                    </div>
                    <div class="form-group">
                        <label for="endDate">Дата закінчення занять</label>
                        <input id="endDate" name="endDate" type="date" th:value="${journal.endDate}" required />
                    </div>
                </div>

                <div class="submit-row" style="margin-top: 1.5rem; justify-content: flex-start; border-top: 1px solid var(--border); padding-top: 1rem;">
                    <button type="submit" class="btn btn--primary">Зберегти Основні Відомості</button>
                </div>
            </form>
        </section>

        <section id="panel-students" class="tab-panel">
            <h3 class="section-title">Облік дітей (Список групи)</h3>
            <p class="helper">Тут буде таблиця зі списком дітей (`journal.students`) та форма для їх додавання/редагування.</p>
        </section>

        <section id="panel-kp1" class="tab-panel">
            <h3 class="section-title">КП-1: Календарно-тематичний план (Вересень - Грудень)</h3>

            <form th:action="@{/journal/{id}/update-ktp-topics(id=${journal.id})}" method="post" class="ktp-form">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <input type="hidden" name="fragment" value="kp1" />

                <div style="margin-bottom: 1rem;">
                    <button type="submit" class="btn btn--primary" onclick="return confirm('Зберегти зміни у темах, датах та примітках КП-1?');">Зберегти теми/дати/примітки КП-1</button>
                </div>

                <table class="table" th:if="${!#lists.isEmpty(kp1Plans)}">
                    <thead>
                    <tr>
                        <th>№</th>
                        <th class="date-col">Планова дата</th>
                        <th class="date-col">Скоригована дата</th>
                        <th class="hours-col">Годин</th>
                        <th>Тема заняття (Редагується)</th>
                        <th class="notes-col">Примітка (Редагується)</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="lesson : ${kp1Plans}" th:classappend="${lesson.isConducted ? 'conducted-row' : ''}">
                        <td th:text="${lesson.lessonNumber}">1</td>

                        <td class="date-col">
                            <span th:text="${lesson.plannedDate != null ? #temporals.format(lesson.plannedDate, 'dd.MM.yyyy') : '—'}"></span>
                        </td>

                        <td class="date-col">
                            <input type="hidden" name="lessonId" th:value="${lesson.id}" />
                            <input type="date" name="correctedDate"
                                   th:value="${lesson.correctedDate != null ? #temporals.format(lesson.correctedDate, 'yyyy-MM-dd') : #temporals.format(lesson.plannedDate, 'yyyy-MM-dd')}"
                                   th:disabled="${lesson.isConducted}"
                                   style="width: 100%;"
                                   class="ktp-input" />
                        </td>

                        <td th:text="${lesson.hours}" class="hours-col">2</td>

                        <td>
                            <textarea name="topic" rows="2"
                                      th:disabled="${lesson.isConducted}"
                                      style="width: 100%;"
                                      class="ktp-input"
                                      th:text="${lesson.topic}"></textarea>
                        </td>

                        <td>
                            <input type="text" name="note" th:value="${lesson.note}"
                                   th:disabled="${lesson.isConducted}"
                                   style="width: 100%;"
                                   class="ktp-input" />
                        </td>
                    </tr>
                    </tbody>
                </table>

                <p class="helper" th:if="${#lists.isEmpty(kp1Plans)}">
                    У першому півріччі немає згенерованих занять. Перевірте розклад та дати.
                </p>

            </form>
        </section>

        <section id="panel-kp2" class="tab-panel">
            <h3 class="section-title">КП-2: Календарно-тематичний план (Січень - Червень)</h3>

            <form th:action="@{/journal/{id}/update-ktp-topics(id=${journal.id})}" method="post" class="ktp-form">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <input type="hidden" name="fragment" value="kp2" />

                <div style="margin-bottom: 1rem;">
                    <button type="submit" class="btn btn--primary" onclick="return confirm('Зберегти зміни у темах, датах та примітках КП-2?');">Зберегти теми/дати/примітки КП-2</button>
                </div>

                <table class="table" th:if="${!#lists.isEmpty(kp2Plans)}">
                    <thead>
                    <tr>
                        <th>№</th>
                        <th class="date-col">Планова дата</th>
                        <th class="date-col">Скоригована дата</th>
                        <th class="hours-col">Годин</th>
                        <th>Тема заняття (Редагується)</th>
                        <th class="notes-col">Примітка (Редагується)</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="lesson : ${kp2Plans}" th:classappend="${lesson.isConducted ? 'conducted-row' : ''}">
                        <td th:text="${lesson.lessonNumber}">1</td>

                        <td class="date-col">
                            <span th:text="${lesson.plannedDate != null ? #temporals.format(lesson.plannedDate, 'dd.MM.yyyy') : '—'}"></span>
                        </td>

                        <td class="date-col">
                            <input type="hidden" name="lessonId" th:value="${lesson.id}" />
                            <input type="date" name="correctedDate"
                                   th:value="${lesson.correctedDate != null ? #temporals.format(lesson.correctedDate, 'yyyy-MM-dd') : #temporals.format(lesson.plannedDate, 'yyyy-MM-dd')}"
                                   th:disabled="${lesson.isConducted}"
                                   style="width: 100%;"
                                   class="ktp-input" />
                        </td>

                        <td th:text="${lesson.hours}" class="hours-col">2</td>

                        <td>
                            <textarea name="topic" rows="2"
                                      th:disabled="${lesson.isConducted}"
                                      style="width: 100%;"
                                      class="ktp-input"
                                      th:text="${lesson.topic}"></textarea>
                        </td>

                        <td>
                            <input type="text" name="note" th:value="${lesson.note}"
                                   th:disabled="${lesson.isConducted}"
                                   style="width: 100%;"
                                   class="ktp-input" />
                        </td>
                    </tr>
                    </tbody>
                </table>

                <p class="helper" th:if="${#lists.isEmpty(kp2Plans)}">
                    У другому півріччі немає згенерованих занять. Перевірте розклад та дати.
                </p>

            </form>
        </section>

        <section id="panel-safety" class="tab-panel">
            <h3 class="section-title">Інструктаж з БЖ</h3>
            <p class="helper">Тут будуть форми для "Вступний інструктаж", "Інструктаж (дати)" та "Інструктаж (список)".</p>
        </section>

        <section id="panel-org" class="tab-panel">
            <h3 class="section-title">Оргмасова робота</h3>
            <p class="helper">Форма для "Оргмасова робота".</p>
        </section>

        <section id="panel-method" class="tab-panel">
            <h3 class="section-title">Методична робота</h3>
            <p class="helper">Форма для "Методична робота".</p>
        </section>

        <section id="panel-creative" class="tab-panel">
            <h3 class="section-title">Творчі досягнення</h3>
            <p class="helper">Форма для "Творчі досягнення".</p>
        </section>

        <section id="panel-report" class="tab-panel">
            <h3 class="section-title">Статзвіт</h3>
            <p class="helper">Форма для "Статзвіт".</p>
        </section>

        <section id="panel-vacation" class="tab-panel">
            <h3 class="section-title">Відпустки, відрядження</h3>
            <p class="helper">Форма для "Відпустки, відрядження".</p>
        </section>

        <section id="panel-remarks" class="tab-panel">
            <h3 class="section-title">Зауваження</h3>
            <p class="helper">Форма для "Зауваження".</p>
        </section>

    </div>
</main>
<script th:src="@{/js/journal.js}"></script>
</body>
</html>