<!DOCTYPE html>
<html lang="uk" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title th:text="${journal.name}">Журнал</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root {
            --bg:#f5f5f5; --card:#fff; --text:#333; --muted:#555;
            --primary:#007bff; --primary-hover:#0056b3; --border:#ddd;
            --shadow:0 2px 10px rgba(0,0,0,.1); --radius:8px;
            --danger:#ef4444; --danger-hover:#c82333;
            --warning: #ffc107; /* Для кнопки КТП */
        }
        * { box-sizing: border-box }
        html, body { height:100%; margin:0; font-family: Arial, sans-serif; background:var(--bg); color:var(--text) }

        /* ===== Header ===== */
        .site-header{ background:var(--card); box-shadow:var(--shadow); position:sticky; top:0; z-index:50 }
        .site-header .container{ max-width:1400px; margin:0 auto; padding:.6rem 1rem; display:flex; align-items:center; gap:.75rem }
        .header-left{ display:flex; align-items:center; gap:.75rem }
        .exit-btn{ padding:.45rem .7rem; border:1px solid var(--border); background:#fff; color:var(--text); border-radius:6px; text-decoration:none }
        .exit-btn:hover{ border-color:#aaa; background:#f9f9f9 }
        .brand{ display:flex; align-items:center; gap:.6rem }
        .brand__logo{ width:32px; height:32px; border-radius:6px; background:var(--primary); display:inline-block }
        .brand__title{ font-size:1.05rem; font-weight:bold }

        /* Навігація журналу (Tabs) */
        .header-tabs{ margin-left:1.5rem; display:flex; gap:.5rem; flex-wrap:wrap; overflow-x: auto; padding-bottom: 5px; }
        .tab-btn{ padding:.5rem .75rem; background:#fff; border:1px solid var(--border); border-radius:6px; cursor:pointer; color:var(--text); white-space: nowrap; }
        .tab-btn:hover{ border-color:var(--primary) }
        .tab-btn.active{ background:var(--primary); color:#fff; border-color:var(--primary) }

        /* ===== Page ===== */
        .page{ max-width:1400px; margin:1rem auto; padding:0 1rem 2rem }
        .card{ background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:1rem 1.25rem; }
        .tab-panel{ display:none }
        .tab-panel.active{ display:block }
        .section-title{ margin:.2rem 0 .75rem; font-size:1.15rem; font-weight: bold; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem; }
        .helper{ color:var(--muted); font-size:.92rem }

        /* Table */
        .table{ width:100%; border-collapse:collapse; border:1px solid var(--border); border-radius:6px; overflow:hidden; margin-top: 1rem; }
        .table th,.table td{ padding:.6rem .75rem; border-bottom:1px solid var(--border); text-align:left; vertical-align:middle; font-size: 0.95rem; }
        .table th{ background:#fafafa; color:var(--muted); font-weight:bold }
        .table tr:last-child td{ border-bottom:none }
        .table td:first-child, .table th:first-child { width: 40px; text-align: center; }
        .table .date-col { width: 120px; }
        .table .hours-col { width: 60px; text-align: center; }
        .table .notes-col { width: 15%; }

        /* Journal Info Header */
        .journal-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 0.75rem 1.5rem;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background-color: #fdfdfd;
            border: 1px solid var(--border);
            border-radius: var(--radius);
        }
        .info-block { word-break: break-word; }
        .info-block strong { color: var(--muted); display: block; font-size: 0.85rem; margin-bottom: 0.25rem; }
        .info-block span { font-size: 1.05rem; }
        .info-block .helper { font-size: 1rem; }

        /* Forms */
        .form-group{ margin-bottom:1rem }
        .form-group label{ display:block; font-weight:bold; color:var(--muted); margin-bottom:.4rem; font-size: .9rem; }
        /* ✅ Стилі для input/select (скопійовані з admin-dashboard) */
        .form-group input[type="text"], .form-group input[type="email"], .form-group input[type="password"],
        .form-group input[type="number"], .form-group input[type="date"], .form-group select {
            width:100%; padding:.65rem .75rem; border:1px solid var(--border); border-radius:6px; font-size:.95rem;
            box-sizing: border-box; /* Важливо, щоб padding не ламав ширину */
        }
        .form-group input:focus, .form-group select:focus {
            outline:none; border-color:var(--primary); box-shadow:0 0 0 2px rgba(0,123,255,.25)
        }

        /* Buttons & Actions */
        .btn{ padding:.4rem .65rem; border-radius:6px; border:1px solid var(--border); background:#fff; cursor:pointer; text-decoration: none; }
        .btn--primary{ background:var(--primary); border-color:var(--primary); color:#fff }
        .btn--danger{ background:var(--danger); border-color:var(--danger); color:#fff }
        .btn--warning{ background:var(--warning); border-color:var(--warning); color:#212529 }
        .btn:hover{ filter:brightness(.95) }

        .actions-bar { display: flex; gap: 0.75rem; align-items: center; margin-bottom: 1.5rem; padding: 0.75rem; background: #fafafa; border-radius: var(--radius); }

        /* Alert Messages */
        .alert-messages { margin-bottom: 1rem; }
        .alert { padding: 1rem; border: 1px solid; border-radius: var(--radius); }
        .alert--error { background: #fff4f4; border-color: #e06666; color: #a04040; }
        .alert--success { background: #f0fff4; border-color: #6aa84f; color: #27501a; }

        @media (max-width:760px){
            .brand__title{ display:none }
            .header-tabs { margin-left: 0.5rem; }
        }
    </style>
</head>
<body>
<header class="site-header">
    <div class="container">
        <div class="header-left">
            <a class="exit-btn" th:href="@{/admin/dashboard#journals}"
               title="Повернутися до Адмін-панелі"
            >Назад</a>
            <span class="brand">
                <span class="brand__logo"></span>
                <span class="brand__title" th:text="${journal.name}">Назва Журналу</span>
            </span>
        </div>

        <nav class="header-tabs" id="journalTabs">
            <button class="tab-btn active" data-tab="info">Основні відомості</button>
            <button class="tab-btn" data-tab="students">Облік дітей</button>
            <button class="tab-btn" data-tab="kp1">КП-1 (Теми)</button>
            <button class="tab-btn" data-tab="kp2">КП-2 (Відвідуваність)</button>
            <button class="tab-btn" data-tab="safety">Інструктаж</button>
            <button class="tab-btn" data-tab="org">Орг. робота</button>
            <button class="tab-btn" data-tab="method">Метод. робота</button>
            <button class="tab-btn" data-tab="creative">Творчі досягнення</button>
            <button class="tab-btn" data-tab="report">Статзвіт</button>
            <button class="tab-btn" data-tab="vacation">Відпустки/Відрядження</button>
            <button class="tab-btn" data-tab="remarks">Зауваження</button>
        </nav>
    </div>
</header>

<main class="page">
    <div class="card">

        <div class="alert-messages">
            <div th:if="${journalError}" class="alert alert--error">
                <strong>Помилка:</strong> <span th:text="${journalError}"></span>
            </div>
            <div th:if="${journalSuccess}" class="alert alert--success">
                <strong>Успіх:</strong> <span th:text="${journalSuccess}"></span>
            </div>
        </div>

        <section id="panel-info" class="tab-panel active">
            <h3 class="section-title">Основні відомості</h3>

            <div class="actions-bar">
                <form th:action="@{/admin/journals/{id}/generate-ktp(id=${journal.id})}" method="post"
                      onsubmit="return confirm('Це видалить існуючий КТП (крім проведених занять) і згенерує новий на основі дат та розкладу. Ви впевнені?');">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                    <button type="submit" class="btn btn--danger">Згенерувати/Оновити КТП</button>
                </form>
                <p class="helper" style="margin: 0;">(Натисніть для автоматичної генерації планових дат на основі розкладу та календаря)</p>
            </div>

            <form th:action="@{/journal/{id}/update-details(id=${journal.id})}" method="post" class="main-details-form">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

                <div class="journal-info">
                    <div class="info-block">
                        <strong>Журнал (Гурток):</strong>
                        <span th:text="${journal.subject.name}">Назва предмету</span>
                    </div>
                    <div class="info-block">
                        <strong>Навчальний рік:</strong>
                        <span th:text="${journal.academicYear.name}">202X-202X</span>
                    </div>
                    <div class="info-block">
                        <strong>Відділ:</strong>
                        <span th:text="${journal.subject.department.name}">Назва відділу</span>
                    </div>
                    <div class="info-block">
                        <strong>Викладачі:</strong>
                        <th:block th:if="${!#lists.isEmpty(journal.teachers)}">
                             <span th:each="teacher, iter : ${journal.teachers}">
                                 <span th:text="${teacher.name + ' ' + teacher.surname}"></span>
                                 <span th:if="!${iter.last}">, </span>
                             </span>
                        </th:block>
                        <span th:if="${#lists.isEmpty(journal.teachers)}" class="helper">Не призначено</span>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
                    <div class="form-group">
                        <label for="programName">Назва програми </label>
                        <input id="programName" name="programName" type="text" th:value="${journal.programName}" placeholder="Навчальна програма" />
                    </div>
                    <div class="form-group">
                        <label for="studyLevel">Рівень навчання</label>
                        <select id="studyLevel" name="studyLevel">
                            <option th:value="${null}" th:text="'— Не обрано —'" th:selected="${journal.studyLevel == null}"></option>
                            <option th:value="'початковий'" th:text="'Початковий'" th:selected="${journal.studyLevel == 'початковий'}"></option>
                            <option th:value="'основний'" th:text="'Основний'" th:selected="${journal.studyLevel == 'основний'}"></option>
                            <option th:value="'вищий'" th:text="'Вищий'" th:selected="${journal.studyLevel == 'вищий'}"></option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="studyYear">Рік навчання</label>
                        <input id="studyYear" name="studyYear" type="text" th:value="${journal.studyYear}" placeholder="Перший, другий..." />
                    </div>
                    <div class="form-group">
                        <label for="groupNumber">Номер групи</label>
                        <input id="groupNumber" name="groupNumber" type="text" th:value="${journal.groupNumber}" placeholder="1, 2, 3..." />
                    </div>

                    <div class="form-group">
                        <label for="hoursPerWeek">Кількість годин на тиждень</label>
                        <input id="hoursPerWeek" name="hoursPerWeek" type="number" th:value="${journal.hoursPerWeek}" required placeholder="Напр., 4" />
                    </div>
                    <div class="form-group">
                        <label for="scheduleJson">Розклад занять (ЧТ: 16:00-17:45, ПТ: 16:00-17:45)</label>
                        <input id="scheduleJson" name="scheduleJson" type="text" th:value="${journal.scheduleJson}" required placeholder="ПН: 10:00-11:45, СР: 10:00-11:45" />
                        <p class="helper">Вкажіть **кожен** день та час через кому (ПН, ВТ, СР, ЧТ, ПТ, СБ, НД).</p>
                    </div>

                    <div class="form-group">
                        <label for="startDate">Дата початку занять</label>
                        <input id="startDate" name="startDate" type="date" th:value="${journal.startDate}" required />
                    </div>
                    <div class="form-group">
                        <label for="endDate">Дата закінчення занять
                        </label>
                        <input id="endDate" name="endDate" type="date" th:value="${journal.endDate}" required />
                    </div>
                </div>

                <div class="submit-row" style="margin-top: 1.5rem; justify-content: flex-start; border-top: 1px solid var(--border); padding-top: 1rem;">
                    <button type="submit" class="btn btn--primary">Зберегти Основні Відомості</button>
                </div>
            </form>
        </section>

        <section id="panel-students" class="tab-panel">
            <h3 class="section-title">Облік дітей (Список групи)</h3>
            <p class="helper">Тут буде таблиця зі списком дітей (`journal.students`) та форма для їх додавання/редагування.</p>
        </section>

        <section id="panel-kp1" class="tab-panel">
            <h3 class="section-title">КП-1: Календарно-тематичний план</h3>

            <table class="table" th:if="${!#lists.isEmpty(lessonPlans)}">
                <thead>
                <tr>
                    <th>№</th>
                    <th class="date-col">Планова дата</th>
                    <th class="date-col">Скоригована дата</th>
                    <th class="hours-col">Годин</th>
                    <th>Тема заняття</th>
                    <th class="notes-col">Примітка</th>
                    <th>Дії</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="lesson : ${lessonPlans}">
                    <td th:text="${lesson.lessonNumber}">1</td>
                    <td th:text="${lesson.plannedDate != null ? #temporals.format(lesson.plannedDate, 'dd.MM.yyyy') : '—'}">05.09.2025</td>
                    <td th:text="${lesson.correctedDate != null ? #temporals.format(lesson.correctedDate, 'dd.MM.yyyy') : '—'}">06.09.2025</td>
                    <td th:text="${lesson.hours}" class="hours-col">2</td>
                    <td th:text="${lesson.topic}">Тема заняття</td>
                    <td th:text="${lesson.note}" class="notes-col"></td>
                    <td>
                        <button class="btn">Редагувати</button>
                    </td>
                </tr>
                </tbody>
            </table>

            <p class="helper" th:if="${#lists.isEmpty(lessonPlans)}">
                Календарно-тематичний план ще не згенеровано.
                <br>
                Перейдіть на вкладку "Основні відомості", заповніть розклад, дати початку/кінця та натисніть кнопку "Згенерувати КТП".
            </p>
        </section>

        <section id="panel-kp2" class="tab-panel">
            <h3 class="section-title">КП-2: Облік відвідуваності та змісту роботи</h3>
            <p class="helper">Тут буде таблиця відвідуваності (з CSV "КП-2") та зміст роботи (з CSV "ВЗР", "ЖЗР" тощо).</p>
        </section>

        <section id="panel-safety" class="tab-panel">
            <h3 class="section-title">Інструктаж з БЖ</h3>
            <p class="helper">Тут будуть форми для "Вступний інструктаж", "Інструктаж (дати)" та "Інструктаж (список)".</p>
        </section>

        <section id="panel-org" class="tab-panel">
            <h3 class="section-title">Оргмасова робота</h3>
            <p class="helper">Форма для "Оргмасова робота".</p>
        </section>

        <section id="panel-method" class="tab-panel">
            <h3 class="section-title">Методична робота</h3>
            <p class="helper">Форма для "Методична робота".</p>
        </section>

        <section id="panel-creative" class="tab-panel">
            <h3 class="section-title">Творчі досягнення</h3>
            <p class="helper">Форма для "Творчі досягнення".</p>
        </section>

        <section id="panel-report" class="tab-panel">
            <h3 class="section-title">Статзвіт</h3>
            <p class="helper">Форма для "Статзвіт".</p>
        </section>

        <section id="panel-vacation" class="tab-panel">
            <h3 class="section-title">Відпустки, відрядження</h3>
            <p class="helper">Форма для "Відпустки, відрядження".</p>
        </section>

        <section id="panel-remarks" class="tab-panel">
            <h3 class="section-title">Зауваження</h3>
            <p class="helper">Форма для "Зауваження".</p>
        </section>

    </div>
</main>

<script>
    // JS для перемикання вкладок (залишається без змін)
    (function(){
        const tabsContainer = document.getElementById('journalTabs');
        if (!tabsContainer) return;
        const tabs = tabsContainer.querySelectorAll('.tab-btn');
        const panels = document.querySelectorAll('.tab-panel');
        function activate(tabName){
            if (!tabName) return;
            tabs.forEach(b => b.classList.toggle('active', b.dataset.tab === tabName));
            panels.forEach(p => p.classList.toggle('active', p.id === 'panel-' + tabName));
            try { history.replaceState(null, '', '#' + tabName); } catch (e) {}
        }
        tabs.forEach(btn => btn.addEventListener('click', (e) => {
            e.preventDefault();
            activate(btn.dataset.tab);
        }));
        const fromHash = location.hash?.replace('#','');
        activate(fromHash || 'info');
    })();
</script>

</body>
</html>